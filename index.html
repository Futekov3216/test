<!DOCTYPE html>
<html lang="en">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>Document</title>
</head>
<body>

   <script>

      if( window.location.href.match(/\?instagram_url=(.*)/) ){
         console.log('toka ? 2') 
         var return_origin = window.location.search.match(/return_url_(.*)end_url/g).toString().replace(/return_url_|end_url/g, '');
         auth_url = window.location.href.match(/\?instagram_url=(.*)/)[1]
               // var auth_url
                     var window_ref
         window.addEventListener('message', (event) => {
            window_ref = event.source 
            window_ref.postMessage('connected', return_origin)
            console.log('event', event)
         })
            let instagram_window_auth = window.open('', '_blank') //prevent the pop up blocker
            instagram_window_auth.location.href = auth_url
      }else{ 

         var insta_code = window.location.search.match(/code=(.*)\&state/g).toString().replace(/code=|\&state|/g, '');
//          var return_origin = window.location.search.match(/return_url_(.*)end_url/g).toString().replace(/return_url_|end_url/g, '');
         console.log('return_origin', return_origin)
         var node_id = window.location.search.match(/node_id_.*/)[0].replace("node_id_", "")
         localStorage.setItem("instagram", JSON.stringify({"node_id":node_id, "insta_code":insta_code }))
         window.close()
      }
      window.addEventListener('storage', () => { 
         window_ref.postMessage(Object.entries(localStorage),"https://sandbox.bg.nc/ilian1/Admin/index.html")
         localStorage.clear();
         window.close()
      })

   </script>
</body>
</html>
