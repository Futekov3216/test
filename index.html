<!DOCTYPE html>
<html lang="en">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>Document</title>
</head>
<body>

   <script>
      function receiveMessage(event)
{
  // Do we trust the sender of this message?

  // event.source is window.opener
  // event.data is "hello there!"

  // Assuming you've verified the origin of the received message (which
  // you must do in any case), a convenient idiom for replying to a
  // message is to call postMessage on event.source and provide
  // event.origin as the targetOrigin.
  event.source.postMessage("hi there yourself!  the secret response " +
                           "is: rheeeeet!",
                           event.origin);
}

window.addEventListener("message", receiveMessage, false);
      // var auth_url
      if( window.location.href.match(/\?instagram_url=(.*)/) ){
         auth_url = window.location.href.match(/\?instagram_url=(.*)/)[1]
         window.open(auth_url, '_blank')
      }else{
         console.log('window.location.search', window.location.search);
         var insta_code = window.location.search.match(/code=(.*)\&state/g).toString().replace(/code=|\&state|/g, '');

         // var node_id = window.location.search.match(/node_id_.*/)[1].replace(/\#_$/, '');
         var node_id = window.location.search.match(/node_id_.*/)[0].replace("node_id_", "")
         localStorage.setItem("instagram", JSON.stringify({"node_id":node_id, "insta_code":insta_code }))
      }

      window.addEventListener('storage', () => {
         window.opener.postMessage(Object.entries(localStorage),"https://sandbox.bg.nc")
         window.close()
      })
         setInterval(() => {
            Object.entries(localStorage)
            window.postMessage(Object.entries(localStorage),"https://sandbox.bg.nc")
         }, 3000)
      // }
      // setInterval(() => {
      //    console.log('hi');
      // }, 3000)

   </script>
</body>
</html>
